#!/bin/bash

# AWS Kafka Container Monitoring Solution - Complete Setup Guide
# This script provides step-by-step CloudWatch implementation for CONTAINERIZED Kafka

echo "üöÄ AWS KAFKA CONTAINER MONITORING - COMPLETE SETUP"
echo "=================================================="
echo "üê≥ This solution monitors Kafka running in Docker containers"
echo ""

# Get system information
REGION=${AWS_REGION:-us-west-2}
INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)

echo "Region: $REGION"
echo "Instance ID: $INSTANCE_ID"
echo ""

echo "üìã STEP-BY-STEP CONTAINER-BASED CLOUDWATCH IMPLEMENTATION"
echo "========================================================="

echo ""
echo "STEP 1: Install CloudWatch Agent"
echo "--------------------------------"
echo "wget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm"
echo "sudo rpm -U ./amazon-cloudwatch-agent.rpm"

echo ""
echo "STEP 2: Deploy Containerized Kafka Infrastructure"
echo "------------------------------------------------"
echo "cd infrastructure/"
echo "docker-compose up -d"
echo "# This creates 3 Kafka broker containers: kafka-1, kafka-2, kafka-3"
echo "# Each container has JMX enabled for monitoring"

echo ""
echo "STEP 3: Create Kafka Topics in Containers"
echo "-----------------------------------------"
echo "docker exec kafka-1 /usr/bin/kafka-topics --create --bootstrap-server localhost:9092 --topic metrics-topic-1 --partitions 3 --replication-factor 3"
echo "docker exec kafka-1 /usr/bin/kafka-topics --create --bootstrap-server localhost:9092 --topic dashboard-metrics-test --partitions 3 --replication-factor 3"

echo ""
echo "STEP 4: Configure CloudWatch Agent for Container Monitoring"
echo "----------------------------------------------------------"
echo "sudo cp configs/cloudwatch-agent-config.json /opt/aws/amazon-cloudwatch-agent/etc/"
echo "sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \\"
echo "  -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/cloudwatch-agent-config.json"
echo "# CloudWatch Agent will now monitor JMX endpoints from containers"

echo ""
echo "STEP 5: Deploy Containerized Java Applications with JMX"
echo "------------------------------------------------------"
echo "# Copy Java files to Kafka container"
echo "docker cp monitoring/kafka-apps/KafkaProducer1.java kafka-1:/tmp/"
echo "docker cp monitoring/kafka-apps/KafkaConsumer1.java kafka-1:/tmp/"
echo ""
echo "# Compile Java applications inside container"
echo "docker exec kafka-1 bash -c 'cd /tmp && javac -cp /usr/share/java/kafka/*:/usr/share/java/cp-base-new/* *.java'"
echo ""
echo "# Start Producer inside container with JMX (Port 9104)"
echo "docker exec -d kafka-1 bash -c 'KAFKA_JMX_OPTS=\"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9104 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false\" java -cp /tmp:/usr/share/java/kafka/*:/usr/share/java/cp-base-new/* KafkaProducer1 > /tmp/producer1.log 2>&1'"
echo ""
echo "# Start Consumer inside container with JMX (Port 9106)"
echo "docker exec -d kafka-1 bash -c 'KAFKA_JMX_OPTS=\"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9106 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false\" java -cp /tmp:/usr/share/java/kafka/*:/usr/share/java/cp-base-new/* KafkaConsumer1 > /tmp/consumer1.log 2>&1'"

echo ""
echo "STEP 6: Deploy CloudWatch Dashboard"
echo "-----------------------------------"
echo "# Import the dashboard JSON directly"
echo "aws cloudwatch put-dashboard \\"
echo "  --dashboard-name \"ApacheKafkaOnEc2-Real\" \\"
echo "  --dashboard-body file://dashboards/current_dashboard.json \\"
echo "  --region $REGION"

echo ""
echo "STEP 7: Setup SNS Alerting"
echo "--------------------------"
echo "# Create SNS topic"
echo "TOPIC_ARN=\$(aws sns create-topic --name kafka-metrics-alerts --region $REGION --query 'TopicArn' --output text)"
echo "echo \"Topic ARN: \$TOPIC_ARN\""
echo ""
echo "# Subscribe to email alerts"
echo "aws sns subscribe --topic-arn \$TOPIC_ARN --protocol email --notification-endpoint YOUR_EMAIL@example.com --region $REGION"
echo ""
echo "# Create CloudWatch alarm for missing metrics"
echo "aws cloudwatch put-metric-alarm \\"
echo "  --alarm-name \"KafkaMetricsMissing\" \\"
echo "  --alarm-description \"Alert when Kafka producer metrics missing for 30 minutes\" \\"
echo "  --metric-name \"kafka.producer.request-rate\" \\"
echo "  --namespace \"CWAgent\" \\"
echo "  --statistic \"Average\" \\"
echo "  --period 300 \\"
echo "  --evaluation-periods 6 \\"
echo "  --threshold 0 \\"
echo "  --comparison-operator \"LessThanThreshold\" \\"
echo "  --treat-missing-data \"breaching\" \\"
echo "  --alarm-actions \"\$TOPIC_ARN\" \\"
echo "  --dimensions \"Name=InstanceId,Value=$INSTANCE_ID\" \\"
echo "  --region $REGION"

echo ""
echo "STEP 8: Deploy Autonomous Watchdog"
echo "----------------------------------"
echo "# Install watchdog as systemd service"
echo "sudo cp monitoring/kafka-keepalive.py /tmp/keepalive.py"
echo "sudo cp monitoring/kafka-keepalive.service /etc/systemd/system/"
echo "sudo systemctl daemon-reload"
echo "sudo systemctl enable kafka-keepalive"
echo "sudo systemctl start kafka-keepalive"

echo ""
echo "STEP 9: Verify Complete Implementation"
echo "-------------------------------------"
echo "# Run verification script to test all 30 metrics"
echo "./scripts/verify-all-widgets.sh"
echo ""
echo "# Check watchdog status"
echo "sudo systemctl status kafka-keepalive"
echo ""
echo "# Check CloudWatch Agent status"
echo "sudo systemctl status amazon-cloudwatch-agent"

echo ""
echo "üéØ CLOUDWATCH DASHBOARD ACCESS"
echo "=============================="
echo "Dashboard URL: https://$REGION.console.aws.amazon.com/cloudwatch/home?region=$REGION#dashboards:name=ApacheKafkaOnEc2-Real"

echo ""
echo "üìä METRICS COVERAGE (30 Total)"
echo "=============================="
echo "‚úÖ Producer Metrics (6): request-rate, response-rate, latency, send-rate, error-rate, byte-rate"
echo "‚úÖ Consumer Metrics (5): fetch-rate, bytes-consumed, records-consumed, bytes-rate, lag-max"
echo "‚úÖ JVM Metrics (10): heap memory, non-heap memory, GC collections, threads, classes"
echo "‚úÖ Kafka Cluster (9): partitions, leader elections, network I/O, requests, purgatory"

echo ""
echo "üõ°Ô∏è CONTAINER-BASED AUTONOMOUS FEATURES"
echo "======================================"
echo "‚úÖ Auto-restart failed Kafka containers (docker-compose restart)"
echo "‚úÖ Auto-restart failed applications inside containers"
echo "‚úÖ Continuous metric injection from containers (every 5 minutes)"
echo "‚úÖ Container health verification (tests all 30 metrics)"
echo "‚úÖ SNS alerting for missing container metrics (30+ minutes)"
echo "‚úÖ Self-healing dashboard (fixes empty widgets from container data)"

echo ""
echo "üîß CONTAINER TROUBLESHOOTING COMMANDS"
echo "===================================="
echo "# Check container status"
echo "docker ps                                    # All running containers"
echo "docker logs kafka-1                         # Kafka broker container logs"
echo "docker logs kafka-2                         # Kafka broker container logs"
echo "docker logs kafka-3                         # Kafka broker container logs"
echo "sudo systemctl status kafka-keepalive       # Watchdog status"
echo "sudo systemctl status amazon-cloudwatch-agent # CloudWatch agent"
echo "./scripts/verify-all-widgets.sh             # Test all container metrics"
echo ""
echo "# Container-specific logs"
echo "sudo journalctl -u kafka-keepalive -f       # Watchdog logs"
echo "docker exec kafka-1 cat /tmp/producer1.log  # Producer logs inside container"
echo "docker exec kafka-1 cat /tmp/consumer1.log  # Consumer logs inside container"
echo ""
echo "# Container restart commands"
echo "docker-compose -f infrastructure/docker-compose.yml restart  # Restart all containers"
echo "docker restart kafka-1 kafka-2 kafka-3     # Restart specific containers"

echo ""
echo "‚úÖ CONTAINER-BASED SETUP COMPLETE!"
echo "================================="
echo "üê≥ Your containerized Kafka monitoring solution is ready!"
echo "üìä All metrics are collected from Docker containers"
echo "üîÑ Watchdog monitors container health and auto-restarts failed containers"
echo "Run the commands above step-by-step to deploy the complete container-based CloudWatch implementation."
